# Troubleshoot MCP Server

A Model Context Protocol (MCP) server that enables AI models to interact with Kubernetes support bundles generated by the [Troubleshoot](https://troubleshoot.sh/) tool.

## Overview

The Troubleshoot MCP server allows AI models to:

1. Initialize support bundles from local files or remote URLs
2. Execute kubectl commands against the bundle's emulated Kubernetes API server
3. Explore and search log files within the bundle
4. Analyze cluster state and diagnose issues

This server acts as a bridge between AI models and the data contained in support bundles, allowing efficient exploration without loading the entire bundle into the model's context.

## Features

- **Bundle Management**
  - Initialize bundles from local files or remote URLs
  - Handle authentication for protected bundles
  - Manage bundle lifecycle

- **Kubectl Integration**
  - Execute arbitrary kubectl commands
  - Formatted command output
  - Support for various output formats

- **File Operations**
  - List files and directories
  - Read file contents with line filtering
  - Search for patterns across files (grep-like functionality)

- **MCP Protocol**
  - Stdio communication (primary)
  - Future support for SSE protocol

## Installation

### Prerequisites

- Python 3.11 or later
- podman (for containerized deployment)
- uv (for Python package management)

### Using podman (recommended)

```bash
# Build the container
podman build -t mcp-server-troubleshoot .

# Run the container
podman run -i --rm \
  -v /path/to/bundles:/bundles \
  -e SBCTL_TOKEN=your_token_here \
  mcp-server-troubleshoot
```

### Using uv (development)

```bash
# Install dependencies
uv venv
uv pip install -e .

# Run the server
python -m mcp_server_troubleshoot
```

## Configuration

### Container Configuration

| Environment Variable | Description | Default |
|----------------------|-------------|---------|
| `SBCTL_TOKEN` | Authentication token for bundle download | None |

### Command Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `--bundles-dir` | Directory to store bundles | `/bundles` |
| `--token-env-var` | Environment variable for auth token | `SBCTL_TOKEN` |

## Usage with Claude Desktop

Add the following to your Claude Desktop configuration:

```json
"mcpServers": {
  "troubleshoot": {
    "command": "podman",
    "args": [
      "run",
      "--rm",
      "-i",
      "-v",
      "/path/to/bundles:/bundles",
      "-e",
      "SBCTL_TOKEN=your_token_here",
      "mcp-server-troubleshoot"
    ]
  }
}
```

## Available Tools

### initialize_bundle

Initialize a support bundle for analysis.

```json
{
  "name": "initialize_bundle",
  "arguments": {
    "source": "https://example.com/support-bundle.tar.gz",
    "force": false
  }
}
```

### kubectl

Execute a kubectl command against the initialized bundle.

```json
{
  "name": "kubectl",
  "arguments": {
    "command": "get pods -n kube-system"
  }
}
```

### list_files

List files and directories within the bundle.

```json
{
  "name": "list_files",
  "arguments": {
    "path": "logs/kube-system"
  }
}
```

### read_file

Read the content of a file from the bundle.

```json
{
  "name": "read_file",
  "arguments": {
    "path": "logs/kube-system/kube-apiserver.log",
    "start_line": 100,
    "end_line": 150
  }
}
```

### grep_files

Search for patterns across files in the bundle.

```json
{
  "name": "grep_files",
  "arguments": {
    "pattern": "Error",
    "path": "logs/kube-system/*.log"
  }
}
```

## Development

### Project Structure

```
mcp-server-troubleshoot/
├── .python-version
├── Dockerfile
├── README.md
├── pyproject.toml
├── tests/
│   ├── __init__.py
│   ├── test_bundle.py
│   ├── test_kubectl.py
│   ├── test_files.py
│   └── test_integration.py
└── src/
    └── mcp_server_troubleshoot/
        ├── __init__.py
        ├── __main__.py
        ├── server.py
        ├── bundle.py
        ├── kubectl.py
        └── files.py
```

### Running Tests

```bash
pytest
```

### Building the Container

```bash
podman build -t mcp-server-troubleshoot .
```

## License

MIT
